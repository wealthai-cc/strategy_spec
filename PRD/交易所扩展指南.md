# 交易所扩展指南

## 概述

WealthAI 策略框架通过适配器模式支持多个交易所。本指南说明如何添加新交易所支持。

## 设计原则

1. **统一接口抽象**：所有交易所通过统一的接口规范交互
2. **差异隔离**：交易所特定差异通过适配层处理，不暴露给策略
3. **Binance 优先**：Binance 作为主要支持的交易所，提供完整参考实现
4. **可扩展性**：新交易所通过标准化流程添加，最小化对现有代码的影响

## 交易所标识规范

- 使用小写字符串标识：`binance`, `okx`, `bybit` 等
- 仅支持字母数字和连字符
- 标识必须唯一且稳定
- 默认为 `binance`（向后兼容）

## 适配器接口

所有交易所适配器必须实现以下接口：

```python
class ExchangeAdapter:
    """交易所适配器接口"""
    
    def get_trading_rule(self, symbol: str) -> dict:
        """
        查询交易规则
        
        Args:
            symbol: 交易对标识（如 "BTCUSDT"）
        
        Returns:
            交易规则字典，包含：
            - symbol: 品种代号
            - min_quantity: 最小下单量
            - quantity_step: 数量步进
            - min_price: 最小价格
            - price_tick: 价格最小变动单位
            - price_precision: 价格精度（小数位数）
            - quantity_precision: 数量精度（小数位数）
            - max_leverage: 最大杠杆倍数
        
        Raises:
            NotFoundError: 交易对不存在
            ParseError: 配置解析失败
        """
        pass
    
    def get_commission_rates(self, symbol: str) -> dict:
        """
        查询佣金费率
        
        Args:
            symbol: 交易对标识（如 "BTCUSDT"）
        
        Returns:
            佣金费率字典，包含：
            - maker_fee_rate: Maker 手续费率（小数）
            - taker_fee_rate: Taker 手续费率（小数）
        
        Raises:
            NotFoundError: 交易对不存在
            ParseError: 配置解析失败
        """
        pass
    
    def validate_configuration(self) -> bool:
        """
        验证适配器配置
        
        Returns:
            True 如果配置有效，False 否则
        """
        pass
    
    def get_supported_symbols(self) -> List[str]:
        """
        获取支持的交易对列表
        
        Returns:
            交易对标识列表
        """
        pass
```

## 添加新交易所的步骤

### 1. 创建适配器类

在 Python SDK 中创建新的适配器类，实现 `ExchangeAdapter` 接口：

```python
# engine/python_sdk/adapters/okx_adapter.py

from typing import List, Dict
from .base import ExchangeAdapter
from ..exceptions import NotFoundError, ParseError

class OKXAdapter(ExchangeAdapter):
    """OKX 交易所适配器"""
    
    def __init__(self, config_path: Optional[str] = None):
        """
        初始化 OKX 适配器
        
        Args:
            config_path: 配置文件路径（可选）
        """
        self.config = self._load_config(config_path)
        if not self.validate_configuration():
            raise ValueError("Invalid OKX adapter configuration")
    
    def get_trading_rule(self, symbol: str) -> dict:
        # 实现 OKX 特定的交易规则查询逻辑
        pass
    
    def get_commission_rates(self, symbol: str) -> dict:
        # 实现 OKX 特定的佣金费率查询逻辑
        pass
    
    def validate_configuration(self) -> bool:
        # 验证配置有效性
        pass
    
    def get_supported_symbols(self) -> List[str]:
        # 返回 OKX 支持的交易对列表
        pass
```

### 2. 创建配置文件

为交易所创建配置文件，包含交易规则和佣金费率：

```yaml
# config/exchanges/okx/trading_rules.yaml

BTCUSDT:
  symbol: BTCUSDT
  min_quantity: 0.00001
  quantity_step: 0.00001
  min_price: 0.01
  price_tick: 0.01
  price_precision: 2
  quantity_precision: 5
  max_leverage: 125

ETHUSDT:
  symbol: ETHUSDT
  min_quantity: 0.0001
  quantity_step: 0.0001
  min_price: 0.01
  price_tick: 0.01
  price_precision: 2
  quantity_precision: 4
  max_leverage: 125
```

```yaml
# config/exchanges/okx/commission_rates.yaml

BTCUSDT:
  maker_fee_rate: 0.0002
  taker_fee_rate: 0.0005

ETHUSDT:
  maker_fee_rate: 0.0002
  taker_fee_rate: 0.0005
```

### 3. 注册适配器

在 Python SDK 的适配器注册表中注册新适配器：

```python
# engine/python_sdk/adapter_registry.py

from .adapters.binance_adapter import BinanceAdapter
from .adapters.okx_adapter import OKXAdapter

ADAPTER_REGISTRY = {
    "binance": BinanceAdapter,
    "okx": OKXAdapter,
}

def get_adapter(exchange: str) -> ExchangeAdapter:
    """
    获取交易所适配器
    
    Args:
        exchange: 交易所标识
    
    Returns:
        适配器实例
    
    Raises:
        NotFoundError: 交易所不支持
    """
    adapter_class = ADAPTER_REGISTRY.get(exchange.lower())
    if adapter_class is None:
        raise NotFoundError(f"Exchange '{exchange}' is not supported")
    return adapter_class()
```

### 4. 更新文档

更新以下文档：

1. **README.md**: 添加新交易所到支持列表
2. **openspec/project.md**: 更新交易所支持说明
3. **openspec/specs/python-sdk/spec.md**: 更新适配器接口文档

### 5. 添加测试

为新适配器添加单元测试和集成测试：

```python
# tests/test_okx_adapter.py

import pytest
from engine.python_sdk.adapters.okx_adapter import OKXAdapter
from engine.python_sdk.exceptions import NotFoundError

def test_okx_adapter_get_trading_rule():
    adapter = OKXAdapter()
    rule = adapter.get_trading_rule("BTCUSDT")
    assert rule["symbol"] == "BTCUSDT"
    assert rule["min_quantity"] > 0
    assert rule["price_precision"] >= 0

def test_okx_adapter_get_commission_rates():
    adapter = OKXAdapter()
    rates = adapter.get_commission_rates("BTCUSDT")
    assert "maker_fee_rate" in rates
    assert "taker_fee_rate" in rates
    assert 0 <= rates["maker_fee_rate"] <= 1
    assert 0 <= rates["taker_fee_rate"] <= 1

def test_okx_adapter_unsupported_symbol():
    adapter = OKXAdapter()
    with pytest.raises(NotFoundError):
        adapter.get_trading_rule("INVALID")
```

## 检查清单

添加新交易所时，请确保：

- [ ] 适配器类实现了所有必需的接口方法
- [ ] 配置文件格式正确且完整
- [ ] 适配器已注册到适配器注册表
- [ ] 单元测试覆盖所有接口方法
- [ ] 集成测试验证适配器与 SDK 的集成
- [ ] 文档已更新（README、项目文档、规范文档）
- [ ] 错误处理正确（NotFoundError、ParseError）
- [ ] 配置验证通过
- [ ] 支持的交易对列表准确

## 参考实现

Binance 适配器作为参考实现，位于 `engine/python_sdk/adapters/binance_adapter.py`。添加新交易所时，可以参考 Binance 适配器的实现方式。

## 常见问题

### Q1: 如何处理交易所特定的差异？

**A**: 所有交易所特定差异应在适配器内部处理，对外提供统一的接口和返回格式。如果某个交易所不支持某些功能，适配器应返回合理的默认值或抛出明确的异常。

### Q2: 配置文件格式必须使用 YAML 吗？

**A**: 不是必须的。配置文件格式由适配器实现决定，可以使用 YAML、JSON、或其他格式。关键是适配器能够正确解析配置并提供统一的数据格式。

### Q3: 如何更新交易规则和佣金费率？

**A**: 更新配置文件后，适配器应提供缓存刷新机制。具体实现方式由适配器决定，可以支持自动刷新或手动刷新。

### Q4: 适配器需要支持实时数据更新吗？

**A**: 不需要。当前设计使用本地配置文件，适配器负责读取和解析配置。如果需要实时数据，可以在适配器内部实现，但不影响接口规范。

## 相关文档

- [Python SDK 规范](../openspec/specs/python-sdk/spec.md)
- [策略执行引擎规范](../openspec/specs/strategy-engine/spec.md)
- [项目上下文](../openspec/project.md)



