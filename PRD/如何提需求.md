# 如何使用 OpenSpec 提需求

本文档说明如何使用 OpenSpec 方式提出和管理需求。

## 快速开始

### 方法 1：使用 Cursor Slash 命令（推荐）

在 Cursor 中直接使用命令：

```
/openspec-proposal 我想添加一个新的订单类型：冰山订单
```

AI 助手会自动：
1. 查看现有规范和代码
2. 创建变更提案目录结构
3. 生成 `proposal.md`、`tasks.md` 和规范变更文档
4. 验证提案格式

### 方法 2：使用命令行

```bash
# 1. 查看现有规范
openspec list --specs

# 2. 手动创建变更提案目录
mkdir -p openspec/changes/add-iceberg-order

# 3. 创建提案文档（或使用 /openspec-proposal 命令自动生成）
```

## 完整流程

### 第一步：提出需求

**在 Cursor 中使用：**
```
/openspec-proposal [你的需求描述]
```

**示例：**
- `/openspec-proposal 我想添加一个新的订单类型：冰山订单`
- `/openspec-proposal 需要支持多品种同时下单`
- `/openspec-proposal 添加订单批量查询接口`

### 第二步：AI 自动创建提案

AI 会创建以下文件结构：

```
openspec/changes/add-iceberg-order/
├── proposal.md          # 为什么改、改什么、影响范围
├── tasks.md             # 实现任务清单
├── design.md            # 技术设计（可选，复杂变更需要）
└── specs/               # 规范变更（delta）
    └── order/
        └── spec.md      # 使用 ## ADDED Requirements 格式
```

### 第三步：评审提案

1. **查看提案内容**：
   ```bash
   openspec show add-iceberg-order
   ```

2. **验证提案格式**：
   ```bash
   openspec validate add-iceberg-order --strict
   ```

3. **人工评审**：
   - 查看 `proposal.md` 了解变更原因和影响
   - 查看 `specs/order/spec.md` 了解规范变更
   - 查看 `tasks.md` 了解实现任务

4. **修改提案**（如需要）：
   - 直接编辑相关文件
   - 重新验证：`openspec validate add-iceberg-order --strict`

### 第四步：实现变更（提案通过后）

**在 Cursor 中使用：**
```
/openspec-apply add-iceberg-order
```

AI 会：
1. 读取 `proposal.md`、`tasks.md`、`design.md`
2. 按顺序实现 `tasks.md` 中的任务
3. 完成后更新任务状态

### 第五步：归档变更（部署后）

**在 Cursor 中使用：**
```
/openspec-archive add-iceberg-order
```

或使用命令行：
```bash
openspec archive add-iceberg-order --yes
```

这会：
1. 将变更移到 `openspec/changes/archive/YYYY-MM-DD-add-iceberg-order/`
2. 自动更新 `openspec/specs/` 中的规范文档（应用 ADDED/MODIFIED/REMOVED）
3. 验证归档结果

## 什么时候需要创建提案？

### ✅ 需要创建提案的情况

- 添加新功能或能力
- 进行破坏性变更（API、数据结构）
- 改变架构或设计模式
- 性能优化（改变行为）
- 更新安全模式
- 不确定是否需要提案时（建议创建，更安全）

### ❌ 不需要创建提案的情况

- Bug 修复（恢复预期行为）
- 拼写错误、格式调整、注释
- 依赖更新（非破坏性）
- 配置变更
- 为现有行为添加测试

## 提案文件说明

### proposal.md

说明变更的原因、内容和影响：

```markdown
# Change: 添加冰山订单类型

## Why
策略需要支持大额订单分批执行，避免对市场造成冲击。

## What Changes
- 添加 `ICEBERG_ORDER_TYPE` 订单类型
- 添加 `visible_size` 字段控制每次可见数量
- 添加 `total_size` 字段控制总订单数量

## Impact
- Affected specs: order
- Affected code: order.proto, 订单处理逻辑
```

### tasks.md

实现任务清单：

```markdown
## 1. Proto 定义
- [ ] 1.1 在 order.proto 中添加 ICEBERG_ORDER_TYPE
- [ ] 1.2 添加 visible_size 和 total_size 字段

## 2. 实现逻辑
- [ ] 2.1 实现冰山订单拆分逻辑
- [ ] 2.2 实现订单状态管理

## 3. 测试
- [ ] 3.1 编写单元测试
- [ ] 3.2 编写集成测试
```

### specs/order/spec.md

规范变更（使用 OpenSpec 格式）：

```markdown
## ADDED Requirements

### Requirement: 冰山订单类型
系统 SHALL 支持冰山订单类型，允许大额订单分批执行。

#### Scenario: 创建冰山订单
- **WHEN** 策略创建冰山订单，设置 visible_size=0.1, total_size=1.0
- **THEN** 系统将订单拆分为多个子订单，每次只显示 0.1 的数量
- **AND** 总订单数量为 1.0

#### Scenario: 冰山订单执行
- **WHEN** 冰山订单的第一个子订单成交
- **THEN** 系统自动创建下一个子订单
- **AND** 直到总数量全部成交
```

## 常用命令

```bash
# 查看所有活动变更
openspec list

# 查看所有规范
openspec list --specs

# 查看具体变更
openspec show <change-id>

# 查看具体规范
openspec show <capability> --type spec

# 验证变更
openspec validate <change-id> --strict

# 归档变更
openspec archive <change-id> --yes
```

## 最佳实践

1. **变更 ID 命名**：
   - 使用 kebab-case：`add-iceberg-order`
   - 使用动词开头：`add-`, `update-`, `remove-`, `refactor-`
   - 保持简短和描述性

2. **规范变更格式**：
   - 必须使用 `## ADDED|MODIFIED|REMOVED Requirements`
   - 每个需求至少包含一个 `#### Scenario:`
   - 使用 `SHALL`/`MUST` 表示强制性要求

3. **任务分解**：
   - 任务要小且可验证
   - 按顺序排列
   - 包含测试和验证步骤

4. **评审流程**：
   - 提案必须通过评审才能开始实现
   - 使用 `openspec validate --strict` 确保格式正确
   - 在 PR 中引用提案

## 示例：完整需求流程

### 1. 提出需求
```
/openspec-proposal 我想添加止损限价单的触发价格回调功能
```

### 2. AI 创建提案
- 创建 `openspec/changes/add-stop-limit-callback/` 目录
- 生成所有必要文件

### 3. 查看和修改提案
```bash
openspec show add-stop-limit-callback
openspec validate add-stop-limit-callback --strict
```

### 4. 提交 PR 评审
- 在 PR 中说明变更原因
- 引用提案文件

### 5. 评审通过后实现
```
/openspec-apply add-stop-limit-callback
```

### 6. 部署后归档
```
/openspec-archive add-stop-limit-callback
```

## 参考文档

- [OpenSpec 工作流程](../openspec/AGENTS.md) - 详细的工作流程说明
- [开发范式文档](./开发范式文档.md) - 项目开发规范
- [OpenSpec 主规格索引](./openspec.md) - 所有规范的索引

---

**提示**：如果不确定是否需要创建提案，建议创建。提案可以帮助理清思路，避免遗漏重要细节。

