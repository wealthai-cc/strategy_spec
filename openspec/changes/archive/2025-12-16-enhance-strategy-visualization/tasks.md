# Tasks: 增强策略测试可视化功能

## 1. 自动生成可视化报告

### 1.1 移除可视化参数
- [ ] 修改 `test_strategy.py` 移除 `--visualize` 参数
- [ ] 修改函数签名，移除 `visualize` 参数
- [ ] 总是初始化数据收集器
- [ ] 总是生成可视化报告
- [ ] 更新命令行参数解析

### 1.2 自动报告命名
- [ ] 实现自动报告文件命名（基于策略文件名）
- [ ] 支持 `--output` 参数指定输出路径（可选）
- [ ] 如果文件已存在，添加时间戳后缀

## 2. 时间分辨率自动检测

### 2.1 实现检测逻辑
- [ ] 创建 `detect_timeframe()` 函数
- [ ] 从策略代码中解析 `get_bars()` 调用
- [ ] 提取 `unit` 或 `frequency` 参数
- [ ] 支持多种检测模式（正则表达式）
- [ ] 编写单元测试

### 2.2 集成到测试工具
- [ ] 在 `test_strategy.py` 中调用检测函数
- [ ] 根据检测结果生成对应粒度的K线数据
- [ ] 如果检测失败，使用默认值并给出警告
- [ ] 更新数据收集器记录时间分辨率

## 3. 策略决策信息收集

### 3.1 扩展数据收集器
- [ ] 添加 `DecisionInfo` 数据类
- [ ] 在 `VisualizationDataCollector` 中添加决策信息收集方法
- [ ] 支持收集技术指标值
- [ ] 支持收集触发条件
- [ ] 支持收集决策依据
- [ ] 支持收集策略状态

### 3.2 实现决策信息提取
- [ ] 分析策略代码提取技术指标计算
- [ ] 分析策略代码提取触发条件
- [ ] 从策略日志中提取决策依据
- [ ] 从策略执行上下文中提取策略状态
- [ ] 编写单元测试

## 4. 技术指标可视化

### 4.1 技术指标计算
- [ ] 实现常用技术指标计算（MA、EMA等）
- [ ] 从收集的决策信息中提取指标值
- [ ] 如果策略已计算，直接使用；否则重新计算
- [ ] 编写单元测试

### 4.2 图表叠加
- [ ] 在K线图上叠加技术指标线
- [ ] 使用不同颜色区分不同指标
- [ ] 添加图例说明
- [ ] 调整图表布局适应叠加内容
- [ ] 编写单元测试

## 5. 增强的买卖点标记

### 5.1 详细信息标注
- [ ] 修改买卖点标记显示完整信息：
  - 价格和数量
  - 技术指标值
  - 触发条件
  - 决策依据
  - 策略状态
- [ ] 优化标注框布局和样式
- [ ] 处理信息过长的情况（折叠/换行）

### 5.2 交互式提示（可选）
- [ ] 实现 hover tooltip 显示详细信息
- [ ] 或者使用可展开的标注框
- [ ] 优化用户体验

## 6. 图表可归因性

### 6.1 触发条件可视化
- [ ] 在图表上标注触发条件的阈值线
- [ ] 显示条件判断结果（满足/不满足）
- [ ] 标注关键决策时间点

### 6.2 图例和说明
- [ ] 添加完整的图例说明
- [ ] 说明各个元素的含义
- [ ] 添加图表说明文字

## 7. 报告内容增强

### 7.1 决策信息展示
- [ ] 在报告中添加决策信息面板
- [ ] 展示每个决策的完整信息
- [ ] 展示技术指标值表格
- [ ] 展示触发条件判断结果

### 7.2 报告布局优化
- [ ] 优化报告布局适应新增内容
- [ ] 确保信息层次清晰
- [ ] 优化移动端显示

## 8. 测试和优化

### 8.1 单元测试
- [ ] 测试时间分辨率检测
- [ ] 测试决策信息收集
- [ ] 测试技术指标计算
- [ ] 测试图表生成

### 8.2 集成测试
- [ ] 测试不同时间分辨率的策略
- [ ] 测试不同决策信息的展示
- [ ] 测试完整流程

### 8.3 性能优化
- [ ] 优化图表生成性能
- [ ] 优化报告生成性能
- [ ] 优化大数据量处理
