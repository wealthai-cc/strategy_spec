# Change: 修复预览服务器生命周期管理

## Why

当前自动预览功能存在以下问题：

1. **预览服务器过早关闭**：预览服务器使用 daemon thread 运行，当 `test_strategy.py` 主进程退出后，daemon thread 也会被终止，导致浏览器打开时无法访问数据文件（出现 "Failed to fetch" 错误）

2. **用户体验不佳**：用户运行测试后，浏览器自动打开但显示错误，需要手动上传文件，违背了"自动预览"的设计目标

3. **文件管理混乱**：每次测试都生成新的 JSON 文件，用户需要手动管理这些文件

4. **HTML 文件冗余**：当前仍会生成 HTML 文件，但用户已经使用 React 模板，HTML 文件不再需要

## What Changes

- **MODIFIED**: 预览服务器生命周期管理
  - 预览服务器应在测试完成后保持运行，直到用户明确关闭或浏览器关闭
  - 使用非 daemon thread 或进程级服务器，确保服务器在测试完成后继续运行
  - 提供优雅的关闭机制（如检测到浏览器关闭后自动停止）

- **MODIFIED**: 测试工具自动预览流程
  - 确保预览服务器在浏览器打开前已启动并可用
  - 添加服务器健康检查，确保数据文件可访问
  - 改进错误提示，当服务器不可用时提供清晰的解决方案

- **REMOVED**: HTML 报告生成（过渡期功能）
  - 移除 HTML 报告生成功能（`--output` 参数保留但不再生成 HTML）
  - 移除对 matplotlib 的依赖（如果仅用于 HTML 报告）
  - 简化测试工具输出，专注于 JSON 数据导出和自动预览

- **MODIFIED**: 文件管理策略
  - JSON 文件可以临时存储在内存或临时目录
  - 或者使用单一文件名覆盖，避免产生多个文件
  - 或者提供清理机制，自动删除旧的测试文件

## Impact

- **Affected specs**: 
  - `strategy-testing` - 修改策略测试可视化规范，移除 HTML 报告要求，强化自动预览要求
- **Affected code**: 
  - `visualization/preview_server.py` - 修改服务器生命周期管理
  - `test_strategy.py` - 修改自动预览流程，移除 HTML 报告生成
  - `visualization/__init__.py` - 移除 HTML 报告相关导出
  - `visualization/report_generator.py` - 标记为废弃或移除
- **Affected docs**: 
  - 更新测试工具使用文档，说明自动预览功能
  - 移除 HTML 报告相关文档

## Design Considerations

### 服务器生命周期管理方案

**方案 1：非 daemon thread + 等待机制**
- 使用非 daemon thread 运行服务器
- 测试完成后，主进程等待用户关闭浏览器或手动停止
- 优点：简单，服务器保证运行
- 缺点：阻塞主进程，用户需要手动停止

**方案 2：进程级服务器 + 信号处理**
- 将服务器作为独立进程运行
- 使用信号处理或文件锁管理服务器生命周期
- 优点：不阻塞主进程
- 缺点：实现复杂，需要进程间通信

**方案 3：单例服务器 + 引用计数**
- 使用单例模式管理预览服务器
- 通过引用计数跟踪使用情况
- 当所有测试完成且浏览器关闭后自动停止
- 优点：资源管理清晰
- 缺点：需要实现引用计数和浏览器检测

**推荐方案**：方案 1（非 daemon thread + 等待机制），因为：
- 实现简单，可靠性高
- 用户通常希望立即查看结果，短暂等待是可接受的
- 可以提供 `--no-wait` 参数允许后台运行

### 文件管理策略

**方案 1：单一文件名覆盖**
- 使用固定文件名（如 `latest_test_data.json`）
- 每次测试覆盖前一个文件
- 优点：不产生多个文件
- 缺点：无法同时查看多个测试结果

**方案 2：临时文件 + 自动清理**
- 使用临时目录存储文件
- 服务器关闭时自动清理
- 优点：不污染工作目录
- 缺点：需要实现清理机制

**方案 3：内存服务器**
- 数据不写入文件，直接在内存中提供
- 优点：不产生文件
- 缺点：实现复杂，需要自定义 HTTP 处理器

**推荐方案**：方案 2（临时文件 + 自动清理），因为：
- 平衡了文件管理和功能需求
- 可以同时支持多个测试（如果需要）
- 自动清理避免文件积累

## Open Questions

1. 是否需要支持同时运行多个测试？如果支持，如何管理多个预览服务器？
2. 浏览器关闭检测：是否需要实现浏览器关闭检测，还是让服务器一直运行直到用户手动停止？
3. HTML 报告是否完全移除，还是保留作为可选功能？

