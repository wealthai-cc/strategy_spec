# 提案审查报告：Unify All JoinQuant APIs in wealthdata Module

## 审查日期
2025-01-XX

## 审查范围
- proposal.md
- tasks.md
- design.md
- specs/strategy-development/spec.md
- specs/strategy-engine/spec.md

## 审查结果

### ✅ 通过项

1. **提案结构完整**
   - proposal.md 包含 Why、What Changes、Impact 三个必需部分
   - 明确标注了 BREAKING changes
   - 影响范围清晰

2. **任务清单详细**
   - tasks.md 包含 6 个主要阶段
   - 每个任务都有明确的子任务
   - 任务顺序合理，有依赖关系

3. **技术设计清晰**
   - design.md 包含 Context、Goals、Decisions、Risks
   - 决策有明确的理由和替代方案
   - 风险识别和缓解措施完整

4. **Spec Deltas 格式正确**
   - 使用了正确的 `## MODIFIED Requirements` 格式
   - 每个 requirement 都有至少一个 scenario
   - Scenario 使用了正确的 `#### Scenario:` 格式和 WHEN/THEN 结构

### ✅ 已改进项

1. **Spec Delta 完整性** ✅
   - **已修复**：strategy-development/spec.md 中的 MODIFIED requirement 现在包含了完整的更新后的内容
   - **包含内容**：所有 API 的详细说明（价格数据、证券信息、策略函数、配置函数）
   - **包含场景**：4 个场景覆盖了主要用例

2. **策略引擎 Spec 的 Requirement 类型** ✅
   - **已修复**：将 "策略加载和兼容对象设置" 改为 ADDED（因为原 spec 中没有对应的 requirement）
   - **新增**：添加了 MODIFIED requirement 用于更新 "Context 线程局部存储"，包含策略模块清理的场景

### 📝 详细审查意见

#### 1. strategy-development/spec.md

**当前内容**：
- 使用了 MODIFIED，requirement 名称匹配原 spec
- 包含了 4 个场景，覆盖了主要用例
- 场景格式正确

**需要补充**：
- 应该包含原 requirement 的完整内容（数据访问 API 的详细说明）
- 需要明确说明哪些部分是新增的，哪些是修改的

**建议修改**：
```markdown
## MODIFIED Requirements

### Requirement: wealthdata 兼容模块（JoinQuant 兼容）

策略可以使用 `wealthdata` 模块进行数据访问，提供与 JoinQuant jqdatasdk 兼容的接口。

**所有 JoinQuant 兼容的 API 必须在 `wealthdata` 模块中定义，策略通过 `from wealthdata import *` 访问所有功能。**

**价格数据 API**：
- `wealthdata.get_price(symbol, count=None, end_date=None, frequency='1h', ...)`：获取价格数据
  - 返回：pandas DataFrame，包含 open, high, low, close, volume 列
  - 与 jqdatasdk.get_price() 接口完全一致
  - 内部映射到 `context.history()` 方法
- `wealthdata.get_bars(symbol, count=None, end_date=None, frequency='1h', ...)`：获取 K 线数据
  - 与 `get_price()` 功能相同，返回格式一致
  - 支持 `unit` 参数（作为 `frequency` 的别名）

**证券信息 API**：
- `wealthdata.get_all_securities(types=None, date=None)`：获取所有交易对信息
- `wealthdata.get_trade_days(start_date=None, end_date=None, count=None)`：获取交易日列表
- `wealthdata.get_index_stocks(index_symbol, date=None)`：获取指数成分
- `wealthdata.get_index_weights(index_symbol, date=None)`：获取指数权重
- `wealthdata.get_fundamentals(valuation, statDate=None, statDateCount=None)`：获取财务数据
- `wealthdata.get_industry(security, date=None)`：获取行业分类
- `wealthdata.get_trades()`：获取成交记录

**策略函数 API**：
- `log`：日志对象，支持 `info()`, `warn()`, `error()`, `debug()` 方法
- `g`：全局变量对象，用于存储策略状态
- `run_daily(func, time='open', reference_security=None)`：注册定时运行函数
- `order_value(symbol, value, price=None)`：按金额下单
- `order_target(symbol, target_qty, price=None)`：目标持仓下单

**配置函数 API**：
- `set_benchmark(security)`：设置基准
- `set_option(key, value)`：设置选项
- `set_order_cost(cost, type='stock')`：设置订单成本
- `OrderCost`：订单成本配置类

#### Scenario: 策略导入所有 JoinQuant API
- **WHEN** 策略执行 `from wealthdata import *`
- **THEN** 所有 JoinQuant 兼容的 API 都可用，包括数据访问、策略函数和配置函数
- **AND** 所有函数和对象都来自 `wealthdata` 模块，无需运行时注入

#### Scenario: 日志输出可见性
- **WHEN** 策略调用 `log.info()`, `log.debug()`, `log.warn()`, 或 `log.error()`
- **THEN** 日志输出必须可见，出现在策略执行的输出中
- **AND** 日志格式为 `[LEVEL] message`，其中 LEVEL 为 INFO、DEBUG、WARN 或 ERROR

#### Scenario: 策略隔离
- **WHEN** 多个策略并发执行
- **THEN** 每个策略有自己独立的 `g` 和 `log` 对象实例
- **AND** 策略之间的状态不会相互干扰

#### Scenario: 无需运行时注入
- **WHEN** 策略使用 `from wealthdata import *`
- **THEN** 所有函数和对象都可用，无需引擎进行运行时注入
- **AND** 策略模块中不需要额外的导入语句

**注意事项**：
- `wealthdata` 模块通过线程局部存储访问当前执行的 Context
- 数据范围受限于 ExecRequest 中的 market_data_context
- 返回 pandas DataFrame 格式，兼容现有 pandas 分析代码
- 支持零代码修改迁移（只需修改 import 语句）
```

#### 2. strategy-engine/spec.md

**当前内容**：
- 使用了 MODIFIED，但需要确认原 spec 中是否有对应的 requirement
- 场景覆盖了主要用例

**需要确认**：
- 原 spec 中是否有 "策略加载和兼容对象设置" 这个 requirement
- 如果没有，应该使用 ADDED 而不是 MODIFIED
- 如果有，需要包含完整的更新后的内容

### ✅ 总体评价

**优点**：
1. 提案目标明确，解决了实际问题（日志不可见、API 分散）
2. 技术设计合理，考虑了策略隔离和线程安全
3. 任务清单详细，实施路径清晰
4. 风险识别完整，有缓解措施

**需要改进**：
1. Spec deltas 需要包含完整的更新后的 requirement 内容
2. 需要确认 strategy-engine 的 requirement 是 MODIFIED 还是 ADDED
3. 建议在 proposal.md 中补充迁移指南的链接

### 📋 审查结论

**状态**：✅ **通过审查**

**改进完成**：
1. ✅ 已补充完整的 MODIFIED requirement 内容
2. ✅ 已确认并修正 strategy-engine 的 requirement 类型（使用 ADDED）
3. ✅ 已添加完整的 API 文档说明

**最终评价**：
- 提案结构完整，目标明确
- Spec deltas 格式正确，内容完整
- 技术设计合理，风险可控
- 任务清单详细，实施路径清晰

**优先级**：高（解决日志可见性问题对用户体验很重要）

**风险评估**：中等（有 BREAKING changes，但影响范围可控，有明确的迁移路径）

**建议**：
- 在实施阶段，建议先进行小范围测试，验证日志输出可见性
- 提供清晰的迁移指南，帮助现有策略迁移到新架构

