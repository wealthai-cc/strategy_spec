# JoinQuant API 实施审计报告

## 任务 1.1: 审计所有 JoinQuant 兼容函数

### 当前状态

#### ✅ 已在 wealthdata.py 中定义的函数：

**数据访问函数**：
- ✅ `get_price` - 从 `engine.wealthdata` 导入
- ✅ `get_bars` - 从 `engine.wealthdata` 导入
- ✅ `get_all_securities` - 从 `engine.wealthdata` 导入
- ✅ `get_trade_days` - 从 `engine.wealthdata` 导入
- ✅ `get_index_stocks` - 从 `engine.wealthdata` 导入
- ✅ `get_index_weights` - 从 `engine.wealthdata` 导入
- ✅ `get_fundamentals` - 从 `engine.wealthdata` 导入
- ✅ `get_industry` - 从 `engine.wealthdata` 导入
- ✅ `get_trades` - 从 `engine.wealthdata` 导入

**策略函数**：
- ✅ `log` - 在 `wealthdata.py` 中定义（Log 类）
- ✅ `g` - 在 `wealthdata.py` 中定义（SimpleNamespace）
- ✅ `run_daily` - 在 `wealthdata.py` 中定义
- ✅ `order_value` - 在 `wealthdata.py` 中定义
- ✅ `order_target` - 在 `wealthdata.py` 中定义

**配置函数**：
- ✅ `set_benchmark` - 在 `wealthdata.py` 中定义
- ✅ `set_option` - 在 `wealthdata.py` 中定义
- ✅ `set_order_cost` - 在 `wealthdata.py` 中定义
- ✅ `OrderCost` - 在 `wealthdata.py` 中定义（类）

**辅助函数**：
- ✅ `get_scheduled_functions` - 在 `wealthdata.py` 中定义
- ✅ `_set_strategy_module` - 在 `wealthdata.py` 中定义（内部使用）
- ✅ `_clear_strategy_module` - 在 `wealthdata.py` 中定义（内部使用）

### 问题发现

1. **重复实现**：
   - `engine/compat/scheduler.py` 中有 `get_scheduled_functions`，但 `wealthdata.py` 中也有
   - `engine/lifecycle/lifecycle.py` 使用 `engine.compat.scheduler.get_scheduled_functions`，应该改为使用 `wealthdata.get_scheduled_functions`

2. **模块注入残留**：
   - `engine/loader/loader.py` 中仍有更新策略模块引用的代码（第 74-81 行），这是必要的，但需要确保不进行函数注入

3. **测试代码依赖**：
   - `test_strategy.py` 和 `diagnose_strategy.py` 使用 `engine.compat.scheduler.get_scheduled_functions`，需要更新

## 任务 1.2: 记录注入 vs. 定义

### 当前注入情况

**已移除注入**（✅ 已完成）：
- `g` - 不再注入到策略模块，只在 `wealthdata` 中设置
- `log` - 不再注入到策略模块，只在 `wealthdata` 中设置
- `run_daily` - 不再注入，在 `wealthdata` 中定义
- `order_value` - 不再注入，在 `wealthdata` 中定义
- `order_target` - 不再注入，在 `wealthdata` 中定义
- `set_benchmark` - 不再注入，在 `wealthdata` 中定义
- `set_option` - 不再注入，在 `wealthdata` 中定义
- `set_order_cost` - 不再注入，在 `wealthdata` 中定义
- `OrderCost` - 不再注入，在 `wealthdata` 中定义

**仍需更新引用**（✅ 已实现）：
- `loader.py` 第 74-81 行：更新策略模块中的 `log` 和 `g` 引用，确保指向 `wealthdata` 中的实例

## 任务 1.3: 日志输出可见性问题

### 根本原因

1. ✅ **已修复**：在策略加载前设置 `wealthdata.log`（`_setup_wealthdata_before_load`）
2. ✅ **已修复**：在策略加载后更新策略模块中的 `log` 引用（第 74-81 行）
3. ✅ **已确认**：Log 类使用 `sys.stdout` 并调用 `flush()`

### 测试验证

- ✅ `initialize` 函数中的 `log.info()` 已能正常显示
- ⚠️ 需要验证 `before_market_open` 和 `market_open` 中的日志输出

## 任务 1.4: 统一 wealthdata 模块结构

### 当前结构

```
wealthdata.py
├── 数据访问函数（从 engine.wealthdata 导入）
├── Log 类定义
├── log 实例
├── g 实例
├── order_value 函数
├── order_target 函数
├── run_daily 函数
├── get_scheduled_functions 函数
├── set_benchmark 函数
├── set_option 函数
├── set_order_cost 函数
├── OrderCost 类
└── __all__ 列表
```

### 设计确认

✅ 所有函数都在 `wealthdata.py` 中
✅ `__all__` 列表包含所有导出
✅ 使用线程局部存储进行策略隔离

