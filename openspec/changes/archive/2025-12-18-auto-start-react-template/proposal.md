# Change: 自动启动 React 模板进行可视化

## Why

当前策略测试可视化流程存在以下问题：

1. **需要手动操作**：用户需要先手动启动 React 模板（`cd visualization/react-template && npm run dev`），然后才能运行测试
2. **流程繁琐**：每次测试都需要两个步骤，无法一键完成
3. **用户体验不佳**：开发者希望运行测试后立即看到可视化结果，而不是先启动服务器

需要改进：
- 运行 `test_strategy.py` 时自动检测 React 模板是否运行
- 如果没运行，自动启动 React 开发服务器
- 等待服务器启动完成后，自动打开浏览器预览
- 用户只需要运行一个命令：`python3 test_strategy.py strategy/xxx.py`

**核心目标**：实现完全自动化的可视化流程，用户只需运行测试文件即可看到可视化结果。

## What Changes

- **ADDED**: 自动启动 React 模板功能
  - 修改 `test_strategy.py` 在检测到 React 未运行时自动启动
  - 使用 `subprocess` 启动 `npm run dev` 进程
  - 等待 React 服务器启动完成（检测端口 5173）
  - 管理 React 服务器进程生命周期

- **ADDED**: React 服务器进程管理
  - 检测 React 服务器是否已在运行
  - 如果已运行，直接使用（不重复启动）
  - 如果未运行，自动启动并等待就绪
  - 可选：提供 `--no-auto-start-react` 参数禁用自动启动

- **MODIFIED**: 预览服务器生命周期管理
  - 结合 `fix-preview-server-lifetime` 的改进
  - 确保预览服务器在测试完成后继续运行
  - 提供优雅的关闭机制

- **MODIFIED**: 测试工具用户体验
  - 简化输出信息，减少手动操作提示
  - 自动处理所有启动和连接逻辑
  - 提供清晰的进度提示

## Impact

- **Affected specs**: 
  - `strategy-testing` - 更新策略测试可视化规范，要求自动启动 React 模板
- **Affected code**: 
  - `test_strategy.py` - 添加 React 服务器自动启动逻辑
  - `visualization/react_launcher.py` - 新增 React 服务器启动和管理模块（可选）
- **Affected docs**: 
  - 更新测试工具使用文档，说明自动启动功能
  - 更新快速开始指南，简化使用步骤

**Non-Breaking**: 现有使用方式继续有效，新增自动启动功能

## Design Considerations

### React 服务器启动方案

**方案 1：subprocess + 后台进程**
- 使用 `subprocess.Popen` 启动 `npm run dev`
- 在后台运行，不阻塞主进程
- 优点：简单，不阻塞
- 缺点：需要管理进程生命周期

**方案 2：subprocess + 等待启动**
- 启动后等待服务器就绪（检测端口）
- 然后继续执行测试
- 优点：确保服务器可用
- 缺点：需要等待时间

**推荐方案**：方案 2（subprocess + 等待启动），因为：
- 确保服务器在测试完成前已就绪
- 用户体验更好（不会出现连接失败）
- 等待时间通常很短（1-3秒）

### 服务器检测方案

**方案 1：端口检测**
- 检测端口 5173 是否被占用
- 优点：简单直接
- 缺点：无法区分是否是 React 服务器

**方案 2：HTTP 请求检测**
- 发送 HTTP 请求到 `http://localhost:5173`
- 检查响应状态
- 优点：准确判断服务器是否可用
- 缺点：需要处理网络错误

**推荐方案**：方案 2（HTTP 请求检测），因为：
- 更准确（端口占用不等于服务器可用）
- 可以检测服务器是否真正响应

### 进程管理方案

**方案 1：不管理进程**
- 启动后不跟踪进程
- 用户手动关闭（Ctrl+C 或关闭终端）
- 优点：简单
- 缺点：无法优雅关闭

**方案 2：跟踪进程并管理生命周期**
- 保存进程对象
- 提供关闭方法
- 测试完成后可选择关闭或保持运行
- 优点：可以控制生命周期
- 缺点：需要实现进程管理

**推荐方案**：方案 2（跟踪进程并管理生命周期），因为：
- 可以优雅关闭（如果需要）
- 可以检测进程是否异常退出
- 更好的用户体验

### 等待策略

**方案 1：固定等待时间**
- 启动后等待固定时间（如 5 秒）
- 优点：简单
- 缺点：可能等待过久或不够

**方案 2：轮询检测**
- 每 0.5 秒检测一次服务器是否就绪
- 最多等待 30 秒
- 优点：准确，不会等待过久
- 缺点：需要实现轮询逻辑

**推荐方案**：方案 2（轮询检测），因为：
- 更准确（服务器启动时间不固定）
- 不会等待过久（有超时机制）
- 用户体验更好（立即响应）

## Open Questions

1. 是否需要支持同时运行多个测试？如果支持，如何管理多个 React 服务器实例？
2. 测试完成后，React 服务器是否应该自动关闭？还是保持运行供后续使用？
3. 如果 React 服务器启动失败（如端口被占用、npm 未安装），如何处理？
4. 是否需要支持自定义 React 服务器端口？

