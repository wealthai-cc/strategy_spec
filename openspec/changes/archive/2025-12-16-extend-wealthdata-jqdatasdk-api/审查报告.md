# OpenSpec Proposal 审查报告

## 提案信息

- **Change ID**: `extend-wealthdata-jqdatasdk-api`
- **审查日期**: 2025-12-16
- **审查人**: AI Assistant

## 审查结果概览

✅ **总体评价**: 提案结构完整，设计合理，可以批准

### 优点

1. ✅ **目标明确**: 清晰说明了为什么要扩展 wealthdata API
2. ✅ **设计合理**: 分阶段实现策略，优先级明确
3. ✅ **文档完整**: proposal.md, design.md, tasks.md, spec.md 都已创建
4. ✅ **风险识别**: 识别了概念不匹配、数据源限制等风险
5. ✅ **向后兼容**: 明确说明是 Non-Breaking 变更

### 需要改进的地方

1. ⚠️ **数据源定义不明确**: 某些 API 的数据源（如指数数据、分类数据）需要更明确的定义
2. ⚠️ **jqdatasdk API 签名需要验证**: 建议验证实际的 jqdatasdk API 签名，确保完全兼容
3. ⚠️ **缺少具体实现示例**: design.md 中的函数签名是设计，建议添加更详细的实现示例

## 详细审查

### 1. proposal.md 审查

#### ✅ 优点
- Why 部分清晰说明了业务价值
- What Changes 部分列出了所有变更
- Impact 部分明确了影响范围
- Design Considerations 提供了适配策略
- Risks 部分识别了主要风险

#### ⚠️ 需要改进
- **Open Questions** 部分的问题需要在实现前解决：
  - 数据源问题：指数数据、分类数据从哪里获取？
  - 适配程度：对于无法完全适配的 API，应该返回什么？
  - 优先级：哪些 API 是用户最需要的？

**建议**: 在开始实现前，先回答这些开放问题，或至少明确 Phase 1 的数据源。

### 2. design.md 审查

#### ✅ 优点
- 决策记录清晰（Decision 1-5）
- 概念映射表有助于理解适配策略
- 每个 API 都有函数签名设计
- 实现细节提供了基本方向

#### ⚠️ 需要改进

1. **get_all_securities() 数据源不明确**
   - 设计中说"从 Context 或 exchange configuration 获取"
   - 但 Context 中可能没有所有交易对列表
   - **建议**: 明确数据源是配置文件还是 ExecRequest 中的信息

2. **get_trade_days() 的 count 参数逻辑**
   - 设计中说"返回最后 30 天"，但没有说明"最后"是相对于什么时间
   - **建议**: 明确是相对于当前时间还是 ExecRequest 的数据范围

3. **get_index_stocks() 和 get_index_weights() 的配置格式**
   - 需要定义配置文件的格式和位置
   - **建议**: 在 Phase 2 开始前，先定义配置格式规范

4. **get_fundamentals() 的 valuation 参数**
   - jqdatasdk 的 `get_fundamentals()` 使用复杂的查询对象
   - 设计中说"may be simplified"，但没有说明如何简化
   - **建议**: 明确简化策略，或提供占位实现

### 3. tasks.md 审查

#### ✅ 优点
- 任务分阶段清晰（Phase 1/2/3）
- 每个 API 都有详细的子任务
- 包含文档更新和测试任务

#### ⚠️ 需要改进

1. **缺少数据源准备任务**
   - Phase 2 需要指数数据，但没有准备数据源的任务
   - **建议**: 在 Phase 2 开始前，添加"准备指数数据配置"任务

2. **缺少配置格式定义任务**
   - 需要定义指数、分类等配置格式
   - **建议**: 在相应 Phase 中添加配置格式定义任务

3. **测试任务可以更具体**
   - 6.3 验证兼容性任务可以更具体
   - **建议**: 添加"使用真实 JoinQuant 策略代码验证"任务

### 4. specs/strategy-development/spec.md 审查

#### ✅ 优点
- 每个 API 都有独立的 Requirement
- 每个 Requirement 都有至少一个 Scenario
- 使用标准的 OpenSpec 格式（SHALL, WHEN, THEN）

#### ⚠️ 需要改进

1. **get_all_securities() 的列名需要验证**
   - spec 中定义的列名：`display_name`, `name`, `start_date`, `end_date`, `type`
   - 需要验证 jqdatasdk 的实际返回格式
   - **建议**: 在实现前验证 jqdatasdk 的实际返回格式

2. **get_trade_days() 的返回顺序**
   - Scenario 中说"descending order (most recent first) or ascending order (matching jqdatasdk)"
   - 需要明确 jqdatasdk 的实际顺序
   - **建议**: 验证 jqdatasdk 的返回顺序，明确规范

3. **get_fundamentals() 的 valuation 参数**
   - spec 中没有详细说明如何处理 valuation 参数
   - **建议**: 添加更详细的参数处理说明

4. **缺少错误处理规范**
   - 某些 API 在找不到数据时应该返回什么，规范不够明确
   - **建议**: 为每个 API 明确错误处理规范

## 与现有文档的一致性检查

### ✅ 一致性良好
- 与 `PRD/JoinQuant迁移指南.md` 中提到的"暂不支持"API 一致
- 与 `openspec/specs/strategy-development/spec.md` 中现有的 wealthdata 说明一致
- 与现有实现（`engine/wealthdata/wealthdata.py`）的架构一致

### ⚠️ 需要更新
- `PRD/JoinQuant迁移指南.md` 中的 Q4 部分需要更新，说明新 API 的支持状态
- `openspec/specs/strategy-development/spec.md` 中的 wealthdata 部分需要更新，添加新 API 说明

## 风险评估

### 低风险 ✅
- Phase 1 的 API（`get_all_securities()`, `get_trade_days()`）实现相对简单
- 向后兼容，不影响现有功能

### 中风险 ⚠️
- Phase 2 的 API 需要定义加密货币指数概念，可能需要额外的数据源
- API 行为可能与 jqdatasdk 有细微差异，需要充分测试

### 高风险 ⚠️
- Phase 3 的 `get_fundamentals()` 概念适配困难，可能无法完全兼容
- 如果实现不当，可能误导用户

## 建议

### 立即执行（批准前）
1. ✅ 验证 jqdatasdk 的实际 API 签名和返回格式
2. ✅ 明确 Phase 1 API 的数据源（特别是 `get_all_securities()`）
3. ✅ 回答 proposal.md 中的 Open Questions

### Phase 1 实现前
1. 定义 `get_all_securities()` 的数据源和配置格式
2. 明确 `get_trade_days()` 的 count 参数逻辑（相对于什么时间）
3. 编写详细的单元测试用例

### Phase 2 实现前
1. 定义加密货币指数的概念和数据结构
2. 设计指数配置文件的格式和位置
3. 准备示例指数数据

### Phase 3 实现前
1. 明确 `get_fundamentals()` 的适配策略（返回什么数据）
2. 定义加密货币分类体系（DeFi, Layer1 等）
3. 设计分类配置文件的格式

## 审查结论

✅ **批准提案，但建议在实现前完成以下工作**：

1. **验证 jqdatasdk API**: 确保函数签名和返回格式的准确性
2. **明确数据源**: 特别是 Phase 1 的 `get_all_securities()` 数据源
3. **回答开放问题**: 解决 proposal.md 中的 Open Questions

**建议的下一步**：
1. 先完成 API 验证和数据源定义
2. 更新 proposal.md 和 design.md，明确数据源和实现细节
3. 然后开始 Phase 1 的实现

## 审查通过条件

- [x] 提案结构完整
- [x] 设计合理
- [x] 任务清单清晰
- [x] 规范变更正确
- [x] **已完成**: 验证 jqdatasdk API 签名（✅ 已完成，详见 `API验证报告.md`）
- [x] **已完成**: 明确 Phase 1 数据源（✅ 已更新 design.md，从 ExecRequest.market_data_context 提取）
- [x] **已完成**: 回答 Open Questions（✅ 已更新 proposal.md）

**总体评价**: ✅ **提案已完善，可以批准并开始实现**

## 更新记录

### 2025-12-16 更新
- ✅ 完成 jqdatasdk API 验证，创建 `API验证报告.md`
- ✅ 更新 `design.md`，明确 Phase 1 API 的数据源和实现细节
- ✅ 更新 `proposal.md`，回答所有 Open Questions
- ✅ 所有审查条件已满足，提案可以批准

