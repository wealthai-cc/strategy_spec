# Change: 添加策略测试可视化前端

## Why

当前策略测试工具（`test_strategy.py`）只能通过命令行输出结果，无法直观地：
1. 查看K线数据和价格走势
2. 看到策略的买卖点标记
3. 理解策略执行的时间线和逻辑
4. 判断策略是否合理执行
5. 验证框架功能是否生效

需要一个可视化前端来：
- 展示测试数据的K线图表
- 标记策略的买卖点（买入/卖出信号）
- 显示每个交易点的详细信息（价格、数量、时间、原因）
- 展示策略执行的时间线
- 帮助开发者理解策略逻辑和框架行为

## What Changes

- **ADDED**: 策略测试可视化前端模块
  - K线图表展示（使用图表库如 matplotlib 或 plotly）
  - 买卖点标记（在K线图上标记买入/卖出信号）
  - 交易详情面板（显示每个交易点的详细信息）
  - 策略执行时间线（展示策略函数的调用顺序）
  - 框架功能验证展示（显示注入的函数、API调用等）

- **ADDED**: 测试数据收集和格式化
  - 从 `test_strategy.py` 收集K线数据
  - 从策略执行结果收集订单操作
  - 从框架收集函数调用和API使用信息
  - 格式化数据供前端使用

- **ADDED**: 可视化输出格式
  - 支持 HTML 报告生成
  - 支持交互式图表（可选）
  - 支持静态图片导出（可选）

- **MODIFIED**: `test_strategy.py`
  - 添加可视化数据收集功能
  - 添加可视化报告生成选项
  - 保持向后兼容（默认不生成可视化，通过参数启用）

## Impact

- **Affected specs**: 
  - `strategy-testing` - 新增策略测试可视化规范
- **Affected code**: 
  - 新增 `visualization/` 模块（K线图表、买卖点标记、交易详情展示）
  - 修改 `test_strategy.py`（添加数据收集和报告生成）
  - 可能需要添加依赖（matplotlib 或 plotly）
- **Affected docs**: 
  - 更新测试工具使用文档
  - 添加可视化报告示例

## Design Considerations

### 技术选型
- **图表库**: 优先使用 matplotlib（轻量、无需浏览器），可选 plotly（交互式）
- **输出格式**: HTML 报告（包含图表和详细信息）
- **数据来源**: 从 `test_strategy.py` 的执行结果中提取

### 核心功能
1. **K线图表**: 展示测试数据的OHLCV
2. **买卖点标记**: 
   - 买入点：绿色向上箭头
   - 卖出点：红色向下箭头
3. **交易详情**: 
   - 交易时间
   - 交易价格
   - 交易数量
   - 交易原因（如：价格 > MA5 * 1.01）
   - 订单状态
4. **策略执行时间线**: 
   - 显示 `initialize`、`before_trading`、`handle_bar` 等函数的调用
   - 显示 `run_daily` 注册的函数调用
5. **框架功能验证**: 
   - 显示已注入的函数列表
   - 显示 wealthdata API 调用
   - 显示订单操作统计

### 非目标
- 实时策略监控（仅用于测试可视化）
- 复杂的回测分析（仅展示单次测试结果）
- 多策略对比（单策略可视化）

