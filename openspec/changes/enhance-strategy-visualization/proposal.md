# Change: 增强策略测试可视化功能

## Why

当前可视化功能存在以下问题：

1. **需要手动启用**：每次测试需要添加 `--visualize` 参数才能生成可视化报告，不够便捷
2. **买卖点信息不足**：图表上的买卖点标记只显示价格和数量，缺少策略决策的关键信息（如触发条件、技术指标值等），无法判断买卖点是否合理
3. **K线粒度不匹配**：测试数据固定生成10天的日线数据，但策略可能使用不同的时间分辨率（如1h），导致数据粒度不匹配，无法真实反映策略的执行情况

需要改进：
- 可视化应该默认启用，每次测试自动生成报告
- 图表需要展示策略决策的完整信息（技术指标、触发条件、决策依据）
- K线数据应该根据策略实际使用的时间分辨率生成

## What Changes

- **MODIFIED**: `test_strategy.py` 可视化集成
  - 移除 `--visualize` 参数，默认自动生成可视化报告
  - 自动检测策略使用的时间分辨率（从 `get_bars()` 调用中提取 `unit` 或 `frequency` 参数）
  - 根据检测到的时间分辨率生成对应粒度的K线数据
  - 自动生成报告文件（默认名称：`{strategy_name}_report.html`）

- **ADDED**: 策略决策信息收集
  - 收集策略执行时的技术指标值（如MA5、MA20等）
  - 收集触发条件判断结果（如"价格 > MA5 * 1.01"）
  - 收集决策依据（买入/卖出的原因）
  - 收集策略状态（持仓、可用资金等）

- **ADDED**: 增强的买卖点标记
  - 在买卖点标记中显示技术指标值
  - 显示触发条件判断结果
  - 显示决策依据和策略状态
  - 添加可交互的提示框（hover tooltip）显示详细信息

- **ADDED**: 图表可归因性
  - 在图表上标注关键的技术指标线（如MA5、MA20）
  - 显示触发条件的阈值线
  - 标注策略决策的关键时间点
  - 添加图例说明各个元素的含义

- **MODIFIED**: 数据收集模块
  - 支持收集技术指标计算结果
  - 支持收集策略决策过程信息
  - 支持收集策略状态快照

## Impact

- **Affected specs**: 
  - `strategy-testing` - 修改策略测试可视化规范
- **Affected code**: 
  - 修改 `test_strategy.py`（移除可视化参数，自动检测时间分辨率）
  - 修改 `visualization/data_collector.py`（添加决策信息收集）
  - 修改 `visualization/chart_generator.py`（增强买卖点标记，添加技术指标线）
  - 修改 `visualization/report_generator.py`（增强报告内容）
- **Affected docs**: 
  - 更新测试工具使用文档
  - 更新可视化报告说明

## Design Considerations

### 时间分辨率自动检测
- 从策略代码中解析 `get_bars()` 或 `get_price()` 调用
- 提取 `unit` 或 `frequency` 参数
- 如果检测不到，使用默认值（1d）并给出警告

### 策略决策信息收集
- 通过分析策略代码中的条件判断语句
- 或者通过策略执行时的日志输出
- 或者通过策略函数返回的决策信息（如果策略支持）

### 技术指标可视化
- 在K线图上叠加技术指标线（如MA5、MA20）
- 使用不同颜色区分不同的指标
- 添加图例说明

### 买卖点信息增强
- 使用更详细的标注框显示：
  - 价格和数量
  - 技术指标值（如MA5=10.65）
  - 触发条件（如"价格 > MA5 * 1.01"）
  - 决策依据（如"价格高于均价1%，买入"）
  - 策略状态（可用资金、持仓等）
