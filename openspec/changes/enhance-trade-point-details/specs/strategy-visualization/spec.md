# Strategy Visualization Specification

## ADDED Requirements

### Requirement: 买卖点详情卡片展示
当用户点击或悬停K线图上的买卖点标记时，系统SHALL在标记附近显示一个详情卡片，包含该买卖点的完整决策信息。

#### Scenario: 点击买入点显示详情
- **WHEN** 用户点击图表上的买入点标记
- **THEN** 在标记附近显示详情卡片
- **AND** 卡片包含：订单方向（买入）、价格、数量、触发条件、技术指标值、条件判断结果、决策依据

#### Scenario: 点击卖出点显示详情
- **WHEN** 用户点击图表上的卖出点标记
- **THEN** 在标记附近显示详情卡片
- **AND** 卡片包含：订单方向（卖出）、价格、数量、触发条件、技术指标值、条件判断结果、决策依据

#### Scenario: 详情卡片智能定位
- **WHEN** 详情卡片显示时
- **THEN** 卡片位置自动调整，避免超出图表边界
- **AND** 优先显示在标记上方或下方，如果空间不足则显示在左侧或右侧

#### Scenario: 详情卡片关闭
- **WHEN** 用户点击卡片外的区域或按ESC键
- **THEN** 详情卡片关闭
- **AND** 图表恢复原始状态

### Requirement: 决策合理性可视化
详情卡片SHALL以直观的方式展示决策是否符合策略要求，使用颜色编码和图标标识判断结果。

#### Scenario: 条件满足时的显示
- **WHEN** 触发条件判断结果为"满足"
- **THEN** 条件判断结果区域显示绿色背景和"✓ 满足"标识
- **AND** 价格与指标的关系显示为绿色（如：价格 > MA5 * 1.01 ✓）

#### Scenario: 条件不满足时的显示
- **WHEN** 触发条件判断结果为"不满足"
- **THEN** 条件判断结果区域显示红色背景和"✗ 不满足"标识
- **AND** 价格与指标的关系显示为红色（如：价格 <= MA5 * 1.01 ✗）

#### Scenario: 决策依据展示
- **WHEN** 详情卡片显示时
- **THEN** 决策依据区域显示完整的决策理由文本
- **AND** 如果决策依据过长，支持展开/折叠

### Requirement: 上下文数据展示
详情卡片SHALL显示该买卖点对应的K线及其前后N根K线的关键数据，便于用户分析决策的上下文。

#### Scenario: 上下文K线数据展示
- **WHEN** 详情卡片显示时
- **THEN** 卡片中包含"上下文数据"区域
- **AND** 显示该K线前后3根K线的：时间、开盘价、收盘价、最高价、最低价、成交量、关键指标值（MA5等）

#### Scenario: 上下文数据折叠
- **WHEN** 上下文数据区域默认折叠
- **WHEN** 用户点击"展开上下文"按钮
- **THEN** 上下文数据展开显示
- **AND** 按钮文本变为"折叠上下文"

### Requirement: 图表聚焦模式
当用户点击买卖点时，系统SHALL提供图表聚焦模式，自动隐藏或淡化非关键的技术指标线，只保留与当前决策相关的指标。

#### Scenario: 买入点聚焦模式
- **WHEN** 用户点击买入点标记
- **THEN** 图表自动进入聚焦模式
- **AND** 隐藏或淡化非关键指标线（如MA10、MA20、MA30、布林带等）
- **AND** 只保留与买入决策相关的指标线（如MA5，因为策略条件是 `price > MA5 * 1.01`）

#### Scenario: 卖出点聚焦模式
- **WHEN** 用户点击卖出点标记
- **THEN** 图表自动进入聚焦模式
- **AND** 隐藏或淡化非关键指标线
- **AND** 只保留与卖出决策相关的指标线（如MA5，因为策略条件是 `price < MA5`）

#### Scenario: 恢复全部指标
- **WHEN** 用户在聚焦模式下点击"显示全部指标"按钮
- **THEN** 所有技术指标线恢复显示
- **AND** 图表退出聚焦模式

### Requirement: 键盘导航支持
系统SHALL支持键盘导航，允许用户使用键盘快速切换买卖点和关闭详情卡片。

#### Scenario: ESC关闭卡片
- **WHEN** 详情卡片显示时
- **WHEN** 用户按ESC键
- **THEN** 详情卡片关闭
- **AND** 图表恢复原始状态

#### Scenario: 方向键切换买卖点
- **WHEN** 详情卡片显示时
- **WHEN** 用户按左方向键
- **THEN** 切换到前一个买卖点（按时间顺序）
- **AND** 详情卡片更新为该买卖点的信息
- **WHEN** 用户按右方向键
- **THEN** 切换到后一个买卖点（按时间顺序）
- **AND** 详情卡片更新为该买卖点的信息

## MODIFIED Requirements

### Requirement: K线图表交互
K线图表SHALL支持点击买卖点标记显示详情卡片，并支持图表聚焦模式。

#### Scenario: 点击买卖点显示详情
- **WHEN** 用户点击图表上的买卖点标记
- **THEN** 在标记附近显示详情卡片（新增）
- **AND** 图表自动进入聚焦模式（新增）
- **AND** 对应的订单在订单列表中高亮显示（保持现有行为）

#### Scenario: 点击K线查找相关订单
- **WHEN** 用户点击K线
- **THEN** 系统查找该K线时间范围内的订单和决策（保持现有行为）
- **AND** 如果找到对应的订单，显示详情卡片（新增）
- **AND** 图表进入聚焦模式（新增）

### Requirement: 详情卡片内容完整性
详情卡片SHALL包含足够的信息，使用户能够完整验证决策的合理性，包括策略条件、实际数据、判断结果和决策依据。

#### Scenario: 买入决策详情完整性
- **WHEN** 用户点击买入点标记
- **THEN** 详情卡片显示：
  - 订单基本信息：方向（买入）、价格、数量
  - 触发条件：完整的条件表达式（如"price > MA5 * 1.01"）
  - 实际数据：当前价格值、MA5值、计算后的阈值（MA5 * 1.01）
  - 判断结果：条件是否满足（✓/✗），颜色编码
  - 技术指标：所有相关指标值（MA5、MA10等）
  - 决策依据：完整的决策理由文本
  - 策略状态：可用资金、持仓数量等

#### Scenario: 卖出决策详情完整性
- **WHEN** 用户点击卖出点标记
- **THEN** 详情卡片显示：
  - 订单基本信息：方向（卖出）、价格、数量
  - 触发条件：完整的条件表达式（如"price < MA5"）
  - 实际数据：当前价格值、MA5值
  - 判断结果：条件是否满足（✓/✗），颜色编码
  - 技术指标：所有相关指标值
  - 决策依据：完整的决策理由文本
  - 策略状态：可用资金、持仓数量等

### Requirement: 上下文数据对比分析
详情卡片SHALL提供该买卖点前后K线的数据对比，帮助用户理解决策的时机和趋势。

#### Scenario: 上下文数据表格展示
- **WHEN** 用户展开上下文数据区域
- **THEN** 显示一个表格，包含7行数据（前3根 + 当前 + 后3根）
- **AND** 每行显示：时间、开盘价、收盘价、最高价、最低价、成交量、MA5值
- **AND** 当前K线行高亮显示（不同背景色）
- **AND** 支持按列排序（可选）

#### Scenario: 趋势可视化
- **WHEN** 上下文数据展开时
- **THEN** 在表格上方显示一个简化的趋势图
- **AND** 趋势图显示这7根K线的收盘价变化
- **AND** 标注当前K线的位置
- **AND** 如果有关键指标（如MA5），在趋势图上叠加显示

