# Design: 增强买卖点详情展示

## Context

当前可视化系统使用 ECharts 展示K线图，买卖点通过 scatter 系列标记。用户点击买卖点时，需要在右侧面板查看详情，无法直接在图表上验证决策合理性。

## Goals / Non-Goals

### Goals
- 在图表上直接展示买卖点决策详情，无需切换面板
- 提供决策合理性判断的可视化反馈
- 展示买卖点附近的上下文数据（前后K线）
- 支持图表聚焦模式，减少信息过载

### Non-Goals
- 不替换现有的右侧面板（保留作为详细信息的补充）
- 不改变现有的数据收集逻辑（只扩展展示方式）
- 不引入新的图表库（继续使用ECharts）

## Decisions

### Decision 1: 详情卡片实现方式
**选择**: 使用 ECharts 的 `graphic` 组件 + React 状态管理

**理由**:
- ECharts `graphic` 组件可以精确控制卡片位置，与图表坐标系对齐
- React 状态管理便于处理交互逻辑（显示/隐藏、定位计算）
- 避免使用 `tooltip`（默认tooltip格式受限，难以展示复杂内容）

**替代方案**:
- 纯 ECharts `tooltip`: 格式受限，难以展示表格和复杂布局
- 外部 DOM 元素: 需要手动计算坐标转换，容易出错

### Decision 2: 详情卡片内容结构
**选择**: 分层展示，核心信息优先

**结构**:
1. **头部**: 订单方向、价格、数量（大字体，颜色编码）
2. **决策判断**: 触发条件、判断结果（突出显示，颜色编码）
3. **技术指标**: 关键指标值（MA5等，与决策相关的）
4. **上下文数据**: 前后3根K线的价格和指标值（折叠/展开）

**理由**:
- 用户最关心的是"这个决策是否合理"，所以决策判断放在显眼位置
- 上下文数据可以折叠，避免卡片过大

### Decision 3: 图表聚焦模式
**选择**: 点击买卖点时，自动隐藏非关键指标线，保留相关指标

**实现**:
- 买入决策：只显示 MA5（因为策略条件是 `price > MA5 * 1.01`）
- 卖出决策：只显示 MA5（因为策略条件是 `price < MA5`）
- 提供"显示全部"按钮恢复

**理由**:
- 减少视觉干扰，聚焦关键信息
- 帮助用户理解决策依据

### Decision 4: 上下文数据范围
**选择**: 前后3根K线（共7根K线：前3 + 当前 + 后3）

**理由**:
- 3根K线足以展示短期趋势
- 7根K线的数据量适中，不会让卡片过大
- 可以根据需要扩展为可配置（用户设置）

## Risks / Trade-offs

### Risk 1: 卡片遮挡图表内容
**Mitigation**: 
- 智能定位：优先显示在标记上方/下方，如果超出边界则自动调整
- 半透明背景，降低遮挡影响
- 支持拖拽移动卡片位置

### Risk 2: 大量买卖点时的性能问题
**Mitigation**:
- 详情卡片只显示一个（点击时关闭之前的）
- 使用 React.memo 优化组件渲染
- 上下文数据计算使用缓存

### Risk 3: 移动端显示问题
**Mitigation**:
- 响应式设计：小屏幕时卡片全屏显示
- 触摸优化：支持滑动查看详情

## Migration Plan

### Phase 1: 基础功能
1. 实现详情卡片组件（基础布局）
2. 实现点击事件处理
3. 显示订单基本信息和决策判断结果

### Phase 2: 增强功能
1. 添加上下文数据展示
2. 实现图表聚焦模式
3. 添加键盘导航

### Phase 3: 优化
1. 性能优化
2. 响应式适配
3. 用户体验优化

### Rollback
- 如果新功能影响现有功能，可以通过配置开关禁用
- 保留现有的右侧面板作为fallback

## Open Questions

1. **卡片显示时机**: 点击还是悬停？还是两者都支持？
   - 建议：点击显示（更稳定），悬停显示简化版（快速预览）

2. **上下文数据格式**: 表格还是列表？
   - 建议：表格（更易对比），但需要响应式适配

3. **聚焦模式的粒度**: 是否需要支持"只显示相关指标"的智能模式？
   - 建议：先实现简单的"显示/隐藏全部"，后续可扩展

