# Change: 改进回测数据生成和策略执行

## Why

当前策略测试存在两个关键问题：

1. **K线数据不够真实**：
   - 虽然已添加随机波动，但波动幅度和模式仍不够接近真实市场
   - OHLC关系虽然正确，但价格变化模式过于简单（线性趋势+随机）
   - 成交量与价格波动的关联性不够强
   - 缺少真实市场的特征（如价格跳空、连续涨跌、震荡区间等）

2. **买卖点只在最后一个点产生**：
   - 对于使用 `run_daily` 的策略，`test_strategy.py` 只手动调用了一次 `market_open` 函数
   - 没有遍历每根K线执行完整的回测，导致策略只在最后一根K线时执行
   - 应该使用 `BacktestEngine` 来执行完整的逐K线回测，确保策略在每根K线上都能根据条件产生买卖点

这两个问题导致：
- 回测结果不准确，无法真实反映策略在历史数据上的表现
- 可视化图表上买卖点分布不合理（集中在最后）
- 无法验证策略在整个回测周期内的执行逻辑

## What Changes

### 1. 改进K线数据生成算法
- **MODIFIED**: `test_strategy.py` 中的K线数据生成逻辑
  - 增加波动幅度（从3倍提升到5-8倍，根据市场类型调整）
  - 添加价格跳空模拟（开盘价可能与前一根K线的收盘价有较大差异）
  - 添加连续涨跌模式（模拟市场情绪，连续上涨或下跌的概率）
  - 添加震荡区间模式（价格在一定区间内震荡）
  - 改进成交量生成：与价格波动、涨跌幅、价格位置（高位/低位）强相关
  - 确保OHLC关系真实（high/low 包含上/下影线，且符合真实K线形态）

### 2. 使用BacktestEngine执行完整回测
- **MODIFIED**: `test_strategy.py` 中的策略执行逻辑
  - 对于使用 `run_daily` 的策略，使用 `BacktestEngine.run_backtest()` 替代手动单次调用
  - 确保遍历每根K线，在每根K线上调用 `before_market_open` 和 `market_open`
  - 收集整个回测周期内的所有订单，而不仅仅是最后一根K线的订单
  - 确保账户状态（现金、持仓）在每根K线之间正确更新

### 3. 增强数据真实性
- **ADDED**: 市场特征模拟
  - 支持不同市场类型的波动特征（A股、美股、港股、加密货币的波动率不同）
  - 支持趋势模式（上升趋势、下降趋势、震荡趋势）
  - 支持突发事件模拟（价格突然大幅波动，可选功能）

## Impact

- **Affected specs**: 
  - `strategy-testing` - 修改策略测试数据生成和执行规范

- **Affected code**:
  - `test_strategy.py` - 修改K线数据生成逻辑和策略执行逻辑
  - `engine/backtest/backtest_engine.py` - 可能需要增强以支持更复杂的数据生成需求

- **User experience**:
  - 回测结果更准确，更接近真实市场表现
  - 可视化图表上买卖点分布更合理，覆盖整个回测周期
  - 能够更好地验证策略逻辑在整个周期内的执行情况

