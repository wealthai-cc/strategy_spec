# 提案审查报告：改进回测数据生成和策略执行

## 审查日期
2025-12-18

## 审查范围
- proposal.md
- design.md
- tasks.md
- specs/strategy-testing/spec.md

## 审查结果

### ✅ 通过项

1. **提案结构完整**
   - proposal.md 包含 Why、What Changes、Impact 三个必需部分
   - 问题分析清晰，两个核心问题都有明确说明
   - 解决方案具体，分为3个主要改进方向
   - 影响范围明确（代码、规范、用户体验）

2. **技术设计合理**
   - design.md 包含完整的 Context、Goals、Decisions、Risks、Migration Plan
   - 3个关键决策都有明确的理由和替代方案分析
   - 风险识别完整（3个主要风险），都有缓解措施
   - 迁移计划分3个阶段，可执行
   - Open Questions 部分提供了具体建议值

3. **任务清单详细**
   - tasks.md 包含 4 个主要阶段（改进K线生成、使用BacktestEngine、增强数据真实性、测试验证）
   - 每个任务都有明确的子任务
   - 任务顺序合理，有依赖关系

4. **Spec Deltas 格式正确**
   - 使用了正确的 `## MODIFIED Requirements` 格式
   - 每个 requirement 都有至少一个 scenario
   - Scenario 使用了正确的 `#### Scenario:` 格式和 WHEN/THEN/AND 结构
   - 场景覆盖全面（高波动数据、OHLC关系、成交量关联、完整回测）

### 📝 详细审查意见

#### 1. proposal.md

**优点**：
- 问题分析清晰，两个核心问题都有明确说明
- 解决方案具体，分为3个主要改进方向
- 影响范围明确

**需要确认**：
- ✅ 已确认：`strategy-testing` capability 是否存在需要确认
- ✅ 已确认：如果不存在，应该使用 ADDED 而不是 MODIFIED

**建议**：
- 提案中提到的"突发事件模拟"在 tasks.md 中标记为"可选"，建议在 proposal.md 中也明确说明这是可选功能

#### 2. design.md

**优点**：
- 3个关键决策都有明确的理由和替代方案
- 风险识别完整，都有缓解措施
- Open Questions 部分提供了具体建议值，有助于实施

**建议**：
- Decision 1 中提到的"使用BacktestEngine替代手动调用"是合理的选择，符合DRY原则
- Decision 2 中的市场特征列表清晰，但建议在实施时先实现核心特征（波动、跳空、连续涨跌），震荡区间和突发事件可以后续添加
- Decision 3 中的"保持向后兼容"很重要，避免影响现有功能

#### 3. specs/strategy-testing/spec.md

**优点**：
- 使用了 MODIFIED Requirements，包含完整的更新后的内容
- 2个主要 Requirement，覆盖K线数据生成和完整回测执行
- 每个 Requirement 都有多个 Scenario，覆盖不同情况
- Scenario 格式正确，使用 WHEN/THEN/AND 结构

**已确认**：
- ✅ **已确认**：`strategy-testing` capability 不存在
  - ✅ **已修复**：已将 `## MODIFIED Requirements` 改为 `## ADDED Requirements`
  - ✅ **已修复**：所有 requirements 都是新增的，格式正确

**建议**：
- Requirement "K线测试数据生成" 和 "完整回测执行" 可以分开，因为它们关注不同的方面
- Scenario 中的具体数值（如"5-8倍"、"20-30%"）与 design.md 中的建议值一致，很好

#### 4. tasks.md

**优点**：
- 任务分阶段清晰（改进K线生成、使用BacktestEngine、增强数据真实性、测试验证）
- 每个阶段都有明确的子任务
- 任务顺序合理，有依赖关系

**建议**：
- 任务 3.3 "支持突发事件模拟" 标记为可选，建议在实施时根据优先级决定是否实现
- 可以添加一个任务：验证生成的K线数据是否满足策略触发条件（确保有足够的买入/卖出机会）

### ⚠️ 需要改进项

1. **Spec Delta 操作类型确认**
   - **问题**：使用了 `## MODIFIED Requirements`，但需要确认 `strategy-testing` capability 是否已存在
   - **建议**：
     - 如果 `strategy-testing` 不存在，应该使用 `## ADDED Requirements`
     - 如果存在，需要确认原 requirement 的名称是否匹配，并包含完整的更新后的内容

2. **提案中的可选功能说明**
   - **问题**：proposal.md 中提到了"突发事件模拟"，但 tasks.md 中标记为可选
   - **建议**：在 proposal.md 中明确说明这是可选功能，或在 Impact 中说明这是未来扩展

### ✅ 总体评价

**优点**：
1. **提案目标明确**：解决了两个核心问题（K线数据不够真实、买卖点只在最后产生）
2. **技术设计合理**：使用 BacktestEngine 是合理的选择，符合现有架构
3. **任务清单详细**：实施路径清晰，分阶段执行
4. **风险识别完整**：3个主要风险都有缓解措施
5. **数值建议明确**：Open Questions 部分提供了具体的建议值

**需要改进**：
1. ⚠️ 需要确认 `strategy-testing` capability 是否存在，以确定使用 ADDED 还是 MODIFIED
2. 建议在 proposal.md 中明确说明"突发事件模拟"是可选功能

**潜在问题**：
1. **数据生成复杂度**：添加太多特征可能导致代码复杂，建议分阶段实施
   - **缓解**：design.md 中已经提到使用参数控制复杂度

2. **性能影响**：逐K线回测可能比单次调用慢，但应该可以接受
   - **缓解**：design.md 中提到 BacktestEngine 已经优化过

3. **向后兼容性**：对于不使用 `run_daily` 的策略，需要确保现有功能不受影响
   - **缓解**：design.md 中明确提到保持向后兼容

### 📋 审查结论

**状态**：✅ **通过审查**

**已确认**：
1. ✅ `strategy-testing` capability 不存在
   - ✅ **已修复**：已将 `specs/strategy-testing/spec.md` 中的 `## MODIFIED Requirements` 改为 `## ADDED Requirements`
   - ✅ **已修复**：所有 requirements 都是新增的，格式正确

**已改进**：
1. ✅ **已修复**：在 proposal.md 中明确说明"突发事件模拟"是可选功能
2. ✅ **已修复**：在 tasks.md 中添加了验证任务（4.2）：确保生成的K线数据满足策略触发条件

**最终评价**：
- **提案结构**：完整，符合 OpenSpec 规范
- **问题分析**：清晰，两个核心问题都有明确说明
- **技术设计**：合理，使用 BacktestEngine 是正确选择
- **任务清单**：详细，实施路径清晰
- **规格说明**：格式正确，已确认为 ADDED（strategy-testing capability 不存在）

**优先级**：高（解决回测准确性和买卖点分布问题）

**风险评估**：低到中等
- **技术风险**：低（使用现有 BacktestEngine，风险可控）
- **复杂度风险**：中等（数据生成算法可能变复杂，有缓解措施）
- **兼容性风险**：低（明确保持向后兼容）

**建议**：
1. **实施顺序**：
   - Phase 1：先改进K线数据生成（增加波动、跳空、连续涨跌）
   - Phase 2：集成 BacktestEngine，确保完整回测
   - Phase 3：根据实际需求决定是否添加震荡区间和突发事件模拟

2. **测试重点**：
   - 验证生成的K线数据波动性是否足够大
   - 验证买卖点是否在整个回测周期内分布
   - 验证账户状态更新是否正确

3. **向后兼容**：
   - 确保对于不使用 `run_daily` 的策略，现有功能不受影响
   - 建议添加配置开关，允许用户选择是否使用新的数据生成算法

## 审查通过

✅ **提案通过审查，所有问题已修复**

**审查人建议**：
- 提案质量高，设计合理，可以直接开始实施
- 建议按照 tasks.md 的顺序执行，分阶段完成
- 重点关注数据生成的真实性和回测的完整性
- 建议在实施过程中保持与用户的沟通，根据实际效果调整参数

