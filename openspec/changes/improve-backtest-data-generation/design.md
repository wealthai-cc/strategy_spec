# Design: 改进回测数据生成和策略执行

## Context

当前策略测试工具 `test_strategy.py` 存在两个主要问题：
1. K线数据生成过于简单，波动不够真实
2. 对于使用 `run_daily` 的策略，只执行了一次 `market_open`，没有遍历每根K线

虽然已有 `BacktestEngine` 实现了完整的逐K线回测逻辑，但 `test_strategy.py` 没有使用它。

## Goals / Non-Goals

### Goals
- 生成更真实的K线数据，波动更大，更接近真实市场
- 确保策略在整个回测周期内逐K线执行，而不是只在最后执行
- 买卖点应该在整个回测周期内分布，而不是集中在最后

### Non-Goals
- 不实现复杂的市场微观结构模拟（如订单簿、滑点等）
- 不实现多品种相关性模拟
- 不实现基本面数据模拟

## Decisions

### Decision 1: 使用BacktestEngine替代手动调用
**选择**: 对于使用 `run_daily` 的策略，使用 `BacktestEngine.run_backtest()` 执行完整回测

**理由**:
- `BacktestEngine` 已经实现了完整的逐K线回测逻辑
- 确保策略在每根K线上都能执行，而不是只在最后执行
- 账户状态会在每根K线之间正确更新

**替代方案**:
- 继续手动调用：需要重复实现回测逻辑，容易出错
- 修改引擎：影响面太大，不符合最小改动原则

### Decision 2: 增强K线数据生成算法
**选择**: 在现有随机波动基础上，添加更多真实市场特征

**特征包括**:
1. **更大的波动幅度**：根据市场类型调整（A股3-5%，美股2-4%，加密货币5-10%）
2. **价格跳空**：开盘价可能与前一根K线收盘价有较大差异（概率20-30%）
3. **连续涨跌**：模拟市场情绪，连续上涨或下跌的概率（趋势延续）
4. **震荡区间**：价格在一定区间内震荡（模拟横盘整理）
5. **成交量关联**：成交量与价格波动、涨跌幅、价格位置强相关

**理由**:
- 真实市场具有这些特征，模拟这些特征能让回测更准确
- 波动更大能更好地测试策略的鲁棒性

**替代方案**:
- 使用真实历史数据：需要数据源，且无法控制数据特征
- 使用更复杂的随机过程（如几何布朗运动）：计算复杂，可能过度设计

### Decision 3: 保持向后兼容
**选择**: 对于不使用 `run_daily` 的策略，保持现有执行方式

**理由**:
- 避免影响现有功能
- 逐步迁移，降低风险

## Risks / Trade-offs

### Risk 1: 数据生成过于复杂
**Mitigation**: 
- 使用参数控制复杂度（如是否启用跳空、连续涨跌等）
- 保持代码清晰，添加注释说明

### Risk 2: 回测性能下降
**Mitigation**:
- `BacktestEngine` 已经优化过，性能应该可以接受
- 如果性能有问题，可以考虑并行化或优化

### Risk 3: 数据生成不可重复
**Mitigation**:
- 使用固定随机种子（`random.seed(42)`）
- 确保每次运行生成相同的数据

## Migration Plan

### Phase 1: 改进K线数据生成
1. 修改 `test_strategy.py` 中的K线生成逻辑
2. 增加波动幅度和真实市场特征
3. 测试生成的数据是否符合要求

### Phase 2: 集成BacktestEngine
1. 修改 `test_strategy.py`，对于使用 `run_daily` 的策略使用 `BacktestEngine`
2. 确保订单收集逻辑正确
3. 验证买卖点是否在整个周期内分布

### Phase 3: 测试与优化
1. 使用实际策略验证回测结果
2. 优化数据生成算法
3. 性能测试

## Open Questions

1. **波动幅度具体数值**：不同市场类型的波动倍数应该是多少？
   - 建议：A股5倍，美股4倍，港股4倍，加密货币8倍

2. **价格跳空概率**：跳空发生的概率应该是多少？
   - 建议：20-30%，跳空幅度为波动幅度的1-3倍

3. **连续涨跌概率**：连续上涨或下跌的概率应该是多少？
   - 建议：60-70%的概率延续前一根K线的方向

