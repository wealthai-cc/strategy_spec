# 使用真实 WebSocket 行情数据测试策略

## 概述

现在可以使用真实的 WebSocket 行情数据来测试策略并生成测试报告。系统会自动从 WebSocket 服务端获取实时行情数据，策略无需修改代码即可使用这些真实数据。

## 快速开始

### 1. 基本使用（模拟数据）

```bash
# 使用模拟数据测试策略（默认模式）
python3 test_strategy.py strategy/double_mean.py
```

### 2. 使用真实 WebSocket 行情数据

```bash
# 使用真实行情数据测试策略
python3 test_strategy.py strategy/double_mean.py --realtime
```

### 3. 等待更长时间接收数据

```bash
# 等待 30 秒接收数据（默认 10 秒）
python3 test_strategy.py strategy/double_mean.py --realtime --wait-seconds 30
```

### 4. 自定义报告输出路径

```bash
# 指定报告输出路径
python3 test_strategy.py strategy/double_mean.py --realtime --output my_report.json
```

## 工作原理

### 数据流程

```
1. 启动 WebSocket 连接
   ↓
2. 订阅指定的交易对和时间周期
   ↓
3. 等待接收真实行情数据（最多等待指定秒数）
   ↓
4. 数据存储到 WebSocket 缓存
   ↓
5. 运行策略测试
   ↓
6. ContextDataAdapter 自动从 WebSocket 缓存读取数据
   ↓
7. 策略通过 wealthdata.get_price() 获取真实数据
   ↓
8. 生成测试报告（包含真实数据）
```

### 透明集成

- **策略代码无需修改**：策略继续使用 `wealthdata.get_price()` 或 `context.history()` 等现有 API
- **自动数据源切换**：`ContextDataAdapter` 自动优先使用 WebSocket 缓存中的真实数据
- **自动回退**：如果 WebSocket 数据不足，自动回退到 Context 中的模拟数据

## 配置

### 环境变量配置

可以通过环境变量配置 WebSocket 连接参数：

```bash
export WEBSOCKET_ENDPOINT="wss://ws.wealthai.cc:18000/market_data"
export WEBSOCKET_CSRF_TOKEN="154c3ceaee6ee63a9fb6aa669873d08aec4655944bce20b6e6c413dc4db0ccd5"
export WEBSOCKET_MARKET_TYPE="binance-testnet"
```

### 命令行参数

```bash
python3 test_strategy.py [策略文件] [选项]

选项:
  --realtime, -r        使用真实 WebSocket 行情数据（默认使用模拟数据）
  --wait-seconds, -w    等待 WebSocket 数据的秒数（默认 10 秒，仅在 --realtime 模式下有效）
  --output, -o          可视化报告输出路径（可选，默认自动命名）
  --no-preview          禁用自动预览功能
  --no-auto-start-react 禁用自动启动 React 服务器
  --react-port          React 服务器端口（默认 5173）
```

**注意**：交易对和时间周期会自动从策略代码中检测，无需手动指定。

## 示例

### 示例 1：测试加密货币策略

```bash
# 测试策略（自动检测交易对和时间周期）
python3 test_strategy.py strategy/double_mean.py --realtime --wait-seconds 20
```

### 示例 2：测试多个周期

```bash
# 先启动 WebSocket 并订阅多个周期
python3 -c "
from engine.python_sdk.websocket_manager import get_websocket_manager
manager = get_websocket_manager()
manager.configure(
    symbols=['BTCUSDT'],
    resolutions=['1m', '5m', '1h']
)
manager.start()
import time
time.sleep(30)  # 等待数据
"

# 然后测试策略（策略会自动使用缓存中的数据）
python3 test_strategy.py strategy/double_mean.py --realtime
```

## 数据状态检查

### 检查 WebSocket 连接状态

```python
from engine.python_sdk.websocket_manager import get_websocket_manager

manager = get_websocket_manager()
status = manager.get_status()
print(f"状态: {status['state']}")
print(f"交易对: {status['symbols']}")
print(f"周期: {status['resolutions']}")
```

### 检查缓存中的数据

```python
from engine.python_sdk.websocket_cache import get_websocket_cache

cache = get_websocket_cache()
symbols = cache.get_cached_symbols()
print(f"已缓存的交易对: {symbols}")

# 获取特定交易对的数据
bars = cache.get_bars('BTCUSDT', '1h')
print(f"BTCUSDT 1h: {len(bars)} 根 K 线")
```

## 故障排查

### 问题 1：WebSocket 连接失败

**症状**：提示 "WebSocket 启动失败"

**解决方案**：
1. 检查网络连接
2. 检查防火墙设置
3. 验证 WebSocket 端点是否正确
4. 检查 `WEBSOCKET_CSRF_TOKEN` 环境变量

### 问题 2：未接收到数据

**症状**：提示 "在 X 秒内未接收到数据"

**解决方案**：
1. 增加 `--wait-seconds` 参数值
2. 检查 WebSocket 服务端是否正常运行
3. 检查订阅的交易对和时间周期是否正确
4. 查看 WebSocket 连接状态

### 问题 3：数据不足

**症状**：策略使用模拟数据而不是真实数据

**解决方案**：
1. 增加等待时间（`--wait-seconds`）
2. 检查 WebSocket 缓存中的数据量
3. 确保订阅的交易对和时间周期与策略需求匹配

## 使用模式对比

| 特性 | 模拟数据模式（默认） | 真实数据模式（--realtime） |
|------|---------------------|---------------------------|
| 数据源 | 模拟数据 | 真实 WebSocket 数据 |
| WebSocket 支持 | ❌ | ✅ |
| 自动检测交易对 | ✅ | ✅ |
| 自动检测时间周期 | ✅ | ✅ |
| 生成测试报告 | ✅ | ✅ |
| 策略代码修改 | ❌ 不需要 | ❌ 不需要 |
| 网络要求 | ❌ 不需要 | ✅ 需要访问 WebSocket 服务端 |

## 注意事项

1. **网络要求**：需要能够访问 WebSocket 服务端（`wss://ws.wealthai.cc:18000/market_data`）
2. **数据等待时间**：真实数据需要时间接收，建议设置合理的 `--wait-seconds` 值
3. **数据量**：WebSocket 缓存最多存储 1000 根 K 线，超出部分会自动清理
4. **回退机制**：如果 WebSocket 数据不可用，系统会自动使用模拟数据，确保测试可以继续

## 下一步

- 查看 [集成指南](./集成指南.md) 了解如何在策略管理系统中集成
- 查看 [快速开始](./快速开始.md) 了解基本使用
- 查看 [测试说明](./测试说明.md) 了解测试方法

